<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Menlo:300,300italic,400,400italic,700,700italic|Monda:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.liwenguang.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="0. 背景最近业务同学在双11做优惠券活动相关的时候，出现了超领的情况，本来定的是一百张，最后超领到了三百多张。最后通过修改数据库的查库存语句解决了问题，峰值1W+ QPS 也没有出现问题。本来想自己整理一下关于库存和超卖的博文，但是在收集资料的时候，发现京东已经有一篇质量非常高的文章，索性直接转发过来了。原文地址：https://www.infoq.cn/article/jingdongdaoj">
<meta name="keywords" content="转载">
<meta property="og:type" content="article">
<meta property="og:title" content="库存与超卖的小结">
<meta property="og:url" content="https://blog.liwenguang.com/2019/11/14/tech/mysql/inventory_system.html/index.html">
<meta property="og:site_name" content="不坠青云志">
<meta property="og:description" content="0. 背景最近业务同学在双11做优惠券活动相关的时候，出现了超领的情况，本来定的是一百张，最后超领到了三百多张。最后通过修改数据库的查库存语句解决了问题，峰值1W+ QPS 也没有出现问题。本来想自己整理一下关于库存和超卖的博文，但是在收集资料的时候，发现京东已经有一篇质量非常高的文章，索性直接转发过来了。原文地址：https://www.infoq.cn/article/jingdongdaoj">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96001.jpg">
<meta property="og:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96002.jpg">
<meta property="og:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96003.jpg">
<meta property="og:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96004.jpg">
<meta property="og:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96005.jpg">
<meta property="og:updated_time" content="2019-12-04T23:18:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="库存与超卖的小结">
<meta name="twitter:description" content="0. 背景最近业务同学在双11做优惠券活动相关的时候，出现了超领的情况，本来定的是一百张，最后超领到了三百多张。最后通过修改数据库的查库存语句解决了问题，峰值1W+ QPS 也没有出现问题。本来想自己整理一下关于库存和超卖的博文，但是在收集资料的时候，发现京东已经有一篇质量非常高的文章，索性直接转发过来了。原文地址：https://www.infoq.cn/article/jingdongdaoj">
<meta name="twitter:image" content="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96001.jpg">

<link rel="canonical" href="https://blog.liwenguang.com/2019/11/14/tech/mysql/inventory_system.html/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>库存与超卖的小结 | 不坠青云志</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146913835-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-146913835-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cfa1bf8fa457ee5150093dc7c8761541";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">不坠青云志</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">严律己，宽待人</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">44</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">186</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    

  <a href="https://github.com/LiWenGu/liwengu.github.io" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liwenguang.com/2019/11/14/tech/mysql/inventory_system.html/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.jpg">
      <meta itemprop="name" content="李文文 | zed">
      <meta itemprop="description" content="Not you, who?">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不坠青云志">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          库存与超卖的小结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-14 22:50:00" itemprop="dateCreated datePublished" datetime="2019-11-14T22:50:00+00:00">2019-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-04 23:18:00" itemprop="dateModified" datetime="2019-12-04T23:18:00+00:00">2019-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术总结/" itemprop="url" rel="index"><span itemprop="name">技术总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术总结/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/11/14/tech/mysql/inventory_system.html/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/14/tech/mysql/inventory_system.html/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h1><p>最近业务同学在双11做优惠券活动相关的时候，出现了超领的情况，本来定的是一百张，最后超领到了三百多张。最后通过修改数据库的查库存语句解决了问题，峰值1W+ QPS 也没有出现问题。<br>本来想自己整理一下关于库存和超卖的博文，但是在收集资料的时候，发现京东已经有一篇质量非常高的文章，索性直接转发过来了。<br>原文地址：<a href="https://www.infoq.cn/article/jingdongdaojia-inventory-system/" target="_blank" rel="noopener">https://www.infoq.cn/article/jingdongdaojia-inventory-system/</a></p>
<a id="more"></a>
<hr>
<p>目前，京东到家库存系统经历两年多的线上考验与技术迭代，现服务着万级商家、十万级店铺的规模，在需求变更与技术演进中，如何做到系统的稳定性与高可用？下面将会给你揭晓答案。</p>
<h1 id="1-库存系统技术架构"><a href="#1-库存系统技术架构" class="headerlink" title="1. 库存系统技术架构"></a>1. 库存系统技术架构</h1><p><img src="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96001.jpg" alt="库存系统技术架构图"></p>
<p>上图如果进行总结下，主要体现出以下几个方面：</p>
<h2 id="1-1-完善的基础设施"><a href="#1-1-完善的基础设施" class="headerlink" title="1.1 完善的基础设施"></a>1.1 完善的基础设施</h2><p>强大的基础服务平台让应用、JVM、Docker、物理机所有健康指标一目了然，7*24 小时智能监控告警让开发无须一直盯着监控。</p>
<h2 id="1-2-数据驱动"><a href="#1-2-数据驱动" class="headerlink" title="1.2 数据驱动"></a>1.2 数据驱动</h2><p>数据与业务相辅相成，用数据验证业务需求，迭代业务需求，让业务需求都尽可能的收益最大化，库存系统的开发同学只需要关注业务需求。</p>
<h2 id="1-3-健全的测试团队"><a href="#1-3-健全的测试团队" class="headerlink" title="1.3 健全的测试团队"></a>1.3 健全的测试团队</h2><p>大版本上线前相应的测试同学会跟进压测，防止上线后潜在的性能瓶颈。</p>
<h2 id="1-4-库存系统技术架构图解释说明"><a href="#1-4-库存系统技术架构图解释说明" class="headerlink" title="1.4 库存系统技术架构图解释说明"></a>1.4 库存系统技术架构图解释说明</h2><h3 id="1-4-1-Portal"><a href="#1-4-1-Portal" class="headerlink" title="1.4.1 Portal"></a>1.4.1 Portal</h3><p>通过提供商家 PC 端、App 端解决大部分中小商家的日常运营需求，另外提供开放平台满足大中型商家系统对接与数据共享互通的问题。</p>
<h3 id="1-4-2-Service"><a href="#1-4-2-Service" class="headerlink" title="1.4.2 Service"></a>1.4.2 Service</h3><p>这个板块涵盖了整个库存最核心的 C&amp;B 数据业务。</p>
<p>1、业务类</p>
<ul>
<li>C 正常流程：用户下单 - 商家拣货 - 快递员妥投</li>
<li>C 异常流程 - 缺货：用户下单 - 商家缺货 - 用户协商 - 调整订单缺货商品 - 商家拣货 - 快递员妥投</li>
<li>C 异常流程 - 取消：用户下单 - 用户反悔 - 订单取消</li>
<li>C 异常流程 - 风控：用户下单 - 风控拦截 - 订单锁定 - 客服审核 - 订单取消 / 继续生产</li>
<li>B 正常流程：商家维护可售库存数量，即时或者定时生效</li>
</ul>
<p>2、数据类</p>
<p>除了业务类需求外，京东到家还提供了大量有商业价值的数据供商家作业务决策，比如：</p>
<ol>
<li>商品销量 Top 榜 - 支持分城市分类目筛选</li>
<li>热销商品库存不足预警 - 商家 App 版本 Push 通知及待办事项中可以醒目识别这部分商品并进行维护</li>
<li>红黄线自动下架 - 近七日订单量大于 5 单，并且被踩率大于等于 20% 的商品，进行下架操作，每日执行。</li>
<li>库存交易流水</li>
</ol>
<p>3、中间件类</p>
<p>古人行军打仗，兵马未动，粮草先行，对于系统来说亦是如此，编码未动架构先行，架构的技术选型非常重要，在这里给大家分享京东技术体系上万码农都在使用的几个中间件。</p>
<ol>
<li>JSF，类似于 DUBBO, 是一款非常优秀的 RPC 层框架，可以解决应用间的数据通信问题，它最主要的优势是长连接的实现以及高效的序列化组件。</li>
<li>JMQ，JMQ 是京东自主研发的一款消息中间件系统，具有高可用、数据高可靠等特性。广泛应用于公司内部系统，包括订单、支付、库房、交易等场景。在库存系统中会优先更新 Redis 缓存数据，并发送变更 MQ，供 MySQL 及 ES 异步更新。</li>
<li>O2OWORKER，早期淘宝开源的一款产品 TBSCHEDULE，不这个只适用于单项目管理，多个系统使用的话权限无法隔离，另外参数配置过于繁琐，结合这两点进行了重构，从而形成了现在的整个京东到家都在使用的任务管理平台。</li>
</ol>
<h3 id="1-4-3-DB"><a href="#1-4-3-DB" class="headerlink" title="1.4.3 DB"></a>1.4.3 DB</h3><p>1、MySQL</p>
<p>京东到家库存系统使用的关系型数据库是 MySQL，低成本、低耦合、轻量级，总之优势多多。</p>
<p>2、Redis</p>
<p>丰富的数据结构 &amp; 众多的原子性命令支持，非常适合库存系统进行缓存查询及扣减操作。</p>
<p>3、ES</p>
<p>库存系统的数据量非常大，首先 MySQL 数据库通过水平扩容来解决单表数据量过大的问题，水平扩容的规则采取的是按门店维度进行分表（1. 目前京东到家还没有到分库的阶段，2. 按门店维度进行分表数据量会相对均衡一些，所以没有按照商家维度进行划分）。</p>
<p>那么在商家 PC 端上查询所有商品库存及维护库存时带来了难度，比如查询该商家下所有的商品有多少条，同时处于上架状态的商品有哪些……，为了解决这一难题，引入了 ES，将数据统一存储在 ES 集群中，解决一些涉及到聚合查询的场景。</p>
<h1 id="2-库存系统数据流转"><a href="#2-库存系统数据流转" class="headerlink" title="2. 库存系统数据流转"></a>2. 库存系统数据流转</h1><p><img src="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96002.jpg" alt="库存系统数据流转图"></p>
<p>库存系统数据流转图解释说明：</p>
<p>库存系统的数据流转，指的都是销售库存的数据流转，在京东到家还有自营类业务板块，即上图中提到的城市仓，由于它涉及到采购入库及盘盈盘亏等问题, 所以会由一套 WMS 系统来支撑。</p>
<p>京东到家设计初衷就是希望商家下的商品各门店共享，带来的问题就是商家新建一个商品时，需要推送到商家下所有的门店中，即所有的门店均可以看到这个商品。或者商家新建一个门店时，需要将商家下所有的商品均推送到这个新建的门店中，所以这采用了 MQ 技术进行异步化批量处理。</p>
<p>写到这里，相信对大家对库存系统有了初步的了解，从上图来看功能上其实并不复杂，但是他面临的技术复杂度却是相当高的，比如秒杀品在高并发的情况下如何防止超卖。</p>
<p>另外库存系统还不是一个纯技术的系统，需要结合用户的行为特点来考虑，比如下文中提到什么时间进行库存的扣减最合适，我们先抛出几个问题和大家一起探讨下，如有不妥之处，欢迎大家拍砖。</p>
<h2 id="2-1-库存什么时候进行预占-或者扣减-呢"><a href="#2-1-库存什么时候进行预占-或者扣减-呢" class="headerlink" title="2.1 库存什么时候进行预占 (或者扣减) 呢"></a>2.1 库存什么时候进行预占 (或者扣减) 呢</h2><p>商家销售的商品数量是有限的，用户下单后商品会被扣减，我们可以怎么实现呢？</p>
<p>举个例子： 一件商品有 1000 个库存，现在有 1000 个用户，每个用户计划同时购买 1000 个。</p>
<ul>
<li>实现方案 1：如果用户加入购物车时进行库存预占，那么将只能有 1 个用户将 1000 个商品加入购物车。</li>
<li>实现方案 2：如果用户提交订单时进行库存预占，那么将也只能有 1 个用户将 1000 个商品提单成功，其它的人均提示“库存不足，提单失败”。</li>
<li>实现方案 3：如果用户提交订单 &amp; 支付成功时进行库存预占，那么这 1000 个人都能生成订单，但是只有 1 个人可以支付成功，其它的订单均会被自动取消。</li>
</ul>
<p>京东到家目前采用的是<strong>方案 2</strong>，理由如下：</p>
<p>用户可能只是暂时加入购物车，并不表示用户最终会提单并支付。</p>
<p>所以在购物车进行库存校验并预占，会造成其它真正想买的用户不能加入购物车的情况，但是之前加车的用户一直不付款，最终损失的是公司。</p>
<p>方案 3 会造成生成 1000 个订单，无论是在支付前校验库存还是在支付成功后再检验库存，都会造成用户准备好支付条件后却会出现 99.9% 的系统取消订单的概率，也就是说会给 99.9% 的用户体验到不爽的感觉。</p>
<p>数据表明用户提交订单不支付的占比是非常小的（相对于加入购物车不购买的行为），目前京东到家给用户预留的最长支付时间是 30 分钟，超过 30 分钟订单自动取消，预占的库存自动释放。</p>
<p>综上所述，方案 2 也可能由于用户下单预占库存但最终未支付，造成库存 30 分钟后才能被其它用户使用的情况，但是相较于方案 1，方案 3 无疑是折中的最好方案。</p>
<h2 id="2-2-重复提交订单的问题？"><a href="#2-2-重复提交订单的问题？" class="headerlink" title="2.2 重复提交订单的问题？"></a>2.2 重复提交订单的问题？</h2><p>重复提交订单造成的库存重复扣减的后果是比较严重的。比如商家设置有 1000 件商品，而实际情况可能卖了 900 件就提示用户无货了，给商家造成无形的损失</p>
<p>可能出现重复提交订单的情况：</p>
<ol>
<li>用户善意行为：app 上用户单击“提交订单”按钮后由于后端接口没有返回，用户以为没有操作成功会再次单击“提交订单”按钮</li>
<li>用户恶意行为：黑客直接刷提单接口，绕过 App 端防重提交功能</li>
<li>提单系统重试：比如提单系统为了提高系统的可用性，在第一次调用库存系统扣减接口超时后会重试再次提交扣减请求</li>
</ol>
<p>好了，既然问题根源缕清楚了，我们一一对症下药</p>
<ol>
<li>用户善意行为：App 侧在用户第一次单击“提交订单”按钮后对按钮进行置灰，禁止再次提交订单</li>
<li>用户恶意行为：采用令牌机制，用户每次进入结算页，提单系统会颁发一个令牌 ID（全局唯一），当用户点击“提交订单”按钮时发起的网络请求中会带上这个令牌 ID, 这个时候提单系统会优先进行令牌 ID 验证，令牌 ID 存在 &amp; 令牌 ID 访问次数 =1 的话才会放行处理后续逻辑，否则直接返回</li>
<li>提单系统重试：这种情况则需要后端系统（比如库存系统）来保证接口的幂等性，每次调用库存系统时均带上订单号，库存系统会基于订单号增加一个分布式事务锁。</li>
</ol>
<p>问题2的解决伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ret = redis.incr(orderId);</span><br><span class="line">redis.expire(orderId, <span class="number">5</span>, Timeunit.MINUTES);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// 添加成功，说明之前没有处理过这个订单号或者5分钟之前处理过了</span></span><br><span class="line">  <span class="keyword">boolean</span> alreadySuccess = alreadySuccessDoOrder(orderProductRequest);</span><br><span class="line">  <span class="keyword">if</span> (!alreadySuccess) &#123;</span><br><span class="line">    doOrder(orderProductRequest);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"操作失败，原因：重复提交"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"操作失败，原因：重复提交"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-库存数据的回滚机制如何做"><a href="#2-3-库存数据的回滚机制如何做" class="headerlink" title="2.3 库存数据的回滚机制如何做?"></a>2.3 库存数据的回滚机制如何做?</h2><p>需要库存回滚的场景也是比较多的，比如：</p>
<ol>
<li>用户未支付：用户下单后后悔了</li>
<li>用户支付后取消：用户下单 &amp; 支付后后悔了</li>
<li>风控取消：风控识别到异常行为，强制取消订单</li>
<li>耦合系统故障：比如提交订单时提单系统 T1 同时会调用积分扣减系统 X1、库存扣减系统 X2、优惠券系统 X3，假如 X1、X2 成功后，调用 X3 失败，需要回滚用户积分与商家库存。</li>
</ol>
<p>其中场景 1、2、3 比较类似，都会造成订单取消，订单中心取消后会发送 MQ 出来，各个系统保证自己能够正确消费订单取消 MQ 即可。</p>
<p>而场景 4 订单其实尚未生成，相对来说要复杂些，如上面提到的，提单系统 T1 需要主动发起库存系统 X2、优惠券系统 X3 的回滚请求（入参必须带上订单号），X2、X3 回滚接口需要支持幂等性。</p>
<p>其实针对场景 4，还存在一种极端情况，如果提单系统 T1 准备回滚时自身也宕机了，那么库存系统 X2、优惠券系统 X3 就必须依靠自己来完成回滚操作了，也就是说具备自我数据健康检查的能力，具体来说怎么实现呢？</p>
<p>可以利用当前订单号所属的订单尚未生成的特点，可以通过 worker 机制，每次捞取 40 分钟（这里的 40 一定要大于容忍用户的支付时间）前的订单，调用订单中心查询订单的状态，确保不是已取消的，否则进行自我数据的回滚。</p>
<h2 id="2-4-多人同时购买-1-件商品，如何安全地库存扣减？"><a href="#2-4-多人同时购买-1-件商品，如何安全地库存扣减？" class="headerlink" title="2.4 多人同时购买 1 件商品，如何安全地库存扣减？"></a>2.4 多人同时购买 1 件商品，如何安全地库存扣减？</h2><p>现实中同一件商品可能会出现多人同时购买的情况，我们可以如何做到并发安全呢？</p>
<p>伪代码片段 1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">  <span class="keyword">long</span> stockNum = getProductStockNum(productId);</span><br><span class="line">  <span class="keyword">if</span> (stockNum &gt; requestBuyNum) &#123;</span><br><span class="line">    String sql = <span class="string">"update stock_main set stockNum = stockNum - "</span> + requestBuyNum + <span class="string">" where productId = "</span> + productId;</span><br><span class="line">    <span class="keyword">int</span> ret = updateSQL(sql);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"扣减成功"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"扣减失败"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>伪代码片段 1 的设计思想是所有的请求过来之后首先加锁，强制其串行化处理，可见其效率一定不高。</p>
<p>伪代码片段 2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> stockNum = getProductStockNum(productId);</span><br><span class="line"><span class="keyword">if</span> (stockNum &gt; requestBuyNum) &#123;</span><br><span class="line">  String sql = <span class="string">"update stock_main set stockNum = stockNum - "</span> + requestBuyNum + <span class="string">" where productId = "</span> + productId + </span><br><span class="line">               <span class="string">" and stockNum &gt;= "</span> + requestBuyNum;</span><br><span class="line">  <span class="keyword">int</span> ret = updateSQL(sql);</span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"扣减成功"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"扣减失败"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码只是在 where 条件里增加了 <code>and stockNum&gt;=requestBuyNum</code> 即可防止超卖的行为，达到了与上述伪代码 1 的功能。</p>
<p>如果商品是促销品（比如参与了秒杀的商品）并发扣减的机率会更高，那么数据库的压力会更高，这个时候还可以怎么做呢?</p>
<p>海量的用户秒杀请求，本质上是一个排序，先到先得。但是如此之多的请求，注定了有些人是抢不到的，可以在进入上述伪代码 Dao 层之前增加一个计数器进行控制，比如有 50% 的流量将直接告诉其抢购失败，伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> BuyResult <span class="title">buy</span> <span class="params">(User user, <span class="keyword">int</span> productId, <span class="keyword">int</span> productNum)</span> </span>&#123;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">if</span> (count % <span class="number">2</span>) &#123;</span><br><span class="line">      Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BuyResult(<span class="string">"抢购失败"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> doBuy(user, productId, productNum);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外同一个用户，不允许多次抢购同一件商品，我们又该如何做呢?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doBuy</span><span class="params">(user, productId, productNum)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 用户除了第一次进入值为1，其它时候均大于1</span></span><br><span class="line">  <span class="keyword">int</span> tmp = redis.incr(user.getUid() + productId);</span><br><span class="line">  <span class="keyword">if</span> (tmp == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 1小时后 key 自动销毁</span></span><br><span class="line">    redis.expire(user.getUid() + productId, <span class="number">3600</span>);</span><br><span class="line">    <span class="keyword">return</span> doBuy1(user, productId, productNum);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BuyResult(<span class="string">"抢购失败"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果同一个用户拥有不同的帐号，来抢购同一件商品，上面的策略就失效了。一些公司在发展早期几乎是没有限制的，很容易就可以注册很多个账号。也即是网络所谓的“僵尸账号”，数量庞大，如果我们使用几万个“僵尸号”混进去抢购，这样就可以大大提升我们中奖的概率，那我们如何应对呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doBuy1</span><span class="params">(user, productId, productNum)</span> </span>&#123;</span><br><span class="line">  String minuteKey = DateTimeUtil.getDateTimeStr(<span class="string">"yyyyMMddHHmm"</span>);</span><br><span class="line">  String minuteIpCount = redis.incr(minuteKey + user.getClientIp());</span><br><span class="line">  <span class="comment">// threshold 为允许每分钟单个 ip 的最大访问次数</span></span><br><span class="line">  <span class="keyword">if</span> (minuteIpCount &gt; threshold) &#123;</span><br><span class="line">    <span class="comment">// 识别到这部分潜在风险用户时，会让这部分用户强制跳转到验证码页面进行校验</span></span><br><span class="line">    <span class="comment">// 校验通过后才能继续抢购商品</span></span><br><span class="line">    <span class="keyword">return</span> getAndSendVerificationCode(user);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doBuy2(user, productId, productNum);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-库存系统的核心表结构设计"><a href="#2-5-库存系统的核心表结构设计" class="headerlink" title="2.5 库存系统的核心表结构设计"></a>2.5 库存系统的核心表结构设计</h2><p>下面列出了库存系统的核心表结构，提供出来供大家在工作中能够有所参考：</p>
<h3 id="2-5-1-库存主表，命名规则：stock-center-00-99-库存主表"><a href="#2-5-1-库存主表，命名规则：stock-center-00-99-库存主表" class="headerlink" title="2.5.1 库存主表，命名规则：stock_center_00~99 库存主表"></a>2.5.1 库存主表，命名规则：stock_center_00~99 库存主表</h3><p><img src="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96003.jpg" alt></p>
<h3 id="2-5-2-库存流水表，命名规则：stock-center-flow-00-99-库存流水表"><a href="#2-5-2-库存流水表，命名规则：stock-center-flow-00-99-库存流水表" class="headerlink" title="2.5.2 库存流水表，命名规则：stock_center_flow_00~99 库存流水表"></a>2.5.2 库存流水表，命名规则：stock_center_flow_00~99 库存流水表</h3><p><img src="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96004.jpg" alt></p>
<h3 id="2-5-3-库存批量操作日志表，命名规则：batch-upload-log-库存批量操作日志表"><a href="#2-5-3-库存批量操作日志表，命名规则：batch-upload-log-库存批量操作日志表" class="headerlink" title="2.5.3 库存批量操作日志表，命名规则：batch_upload_log 库存批量操作日志表"></a>2.5.3 库存批量操作日志表，命名规则：batch_upload_log 库存批量操作日志表</h3><p><img src="https://leran2deeplearnjavawebtech.oss-cn-beijing.aliyuncs.com/somephoto/2019-11-14%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96005.jpg" alt></p>
<h1 id="3-思考"><a href="#3-思考" class="headerlink" title="3 思考"></a>3 思考</h1><ol>
<li>关键在于库存扣除的核心代码，考虑并发量以及数据库性能，并依赖 Redis 来实现可靠的代码。我在实际中使用的就是通过 SQL 增加 <code>and stockNum&gt;=requestBuyNum</code> 来保证不会库存多扣。  </li>
<li>但是关于订单取消的逻辑，我们是使用的 30 分钟之后自动取消，接着业务走相关类似的逻辑。</li>
</ol>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
        <div class="popular-posts-date">2018-12-24</div>
      <div class="popular-posts-title"><a href="/2018/12/24/reprint_jvm/concurrenthashmap.html/" rel="bookmark">谈谈 ConcurrentHashMap 1.7 和 1.8 的不同实现</a></div>
    </li>
    <li class="popular-posts-item">
        <div class="popular-posts-date">2017-12-05</div>
      <div class="popular-posts-title"><a href="/2017/12/05/talker/decentralization_1.html/" rel="bookmark">去中心化</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>李文文 | zed
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://blog.liwenguang.com/2019/11/14/tech/mysql/inventory_system.html/" title="库存与超卖的小结">https://blog.liwenguang.com/2019/11/14/tech/mysql/inventory_system.html/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-cn" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/转载/" rel="tag"><i class="fa fa-tag"></i> 转载</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/11/11/2019/45.html/" rel="prev" title="2019/45周总结">
      <i class="fa fa-chevron-left"></i> 2019/45周总结
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/11/27/2019/47.html/" rel="next" title="2019/47周总结">
      2019/47周总结 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-背景"><span class="nav-text">0. 背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-库存系统技术架构"><span class="nav-text">1. 库存系统技术架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-完善的基础设施"><span class="nav-text">1.1 完善的基础设施</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-数据驱动"><span class="nav-text">1.2 数据驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-健全的测试团队"><span class="nav-text">1.3 健全的测试团队</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-库存系统技术架构图解释说明"><span class="nav-text">1.4 库存系统技术架构图解释说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-Portal"><span class="nav-text">1.4.1 Portal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-2-Service"><span class="nav-text">1.4.2 Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-3-DB"><span class="nav-text">1.4.3 DB</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-库存系统数据流转"><span class="nav-text">2. 库存系统数据流转</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-库存什么时候进行预占-或者扣减-呢"><span class="nav-text">2.1 库存什么时候进行预占 (或者扣减) 呢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-重复提交订单的问题？"><span class="nav-text">2.2 重复提交订单的问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-库存数据的回滚机制如何做"><span class="nav-text">2.3 库存数据的回滚机制如何做?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-多人同时购买-1-件商品，如何安全地库存扣减？"><span class="nav-text">2.4 多人同时购买 1 件商品，如何安全地库存扣减？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-库存系统的核心表结构设计"><span class="nav-text">2.5 库存系统的核心表结构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-库存主表，命名规则：stock-center-00-99-库存主表"><span class="nav-text">2.5.1 库存主表，命名规则：stock_center_00~99 库存主表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-库存流水表，命名规则：stock-center-flow-00-99-库存流水表"><span class="nav-text">2.5.2 库存流水表，命名规则：stock_center_flow_00~99 库存流水表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-3-库存批量操作日志表，命名规则：batch-upload-log-库存批量操作日志表"><span class="nav-text">2.5.3 库存批量操作日志表，命名规则：batch_upload_log 库存批量操作日志表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-思考"><span class="nav-text">3 思考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="李文文 | zed"
      src="/images/avatar2.jpg">
  <p class="site-author-name" itemprop="name">李文文 | zed</p>
  <div class="site-description" itemprop="description">Not you, who?</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">186</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/LiWenGu" title="GitHub → https://github.com/LiWenGu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liwenguang_dev@163.com" title="E-Mail → mailto:liwenguang_dev@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="rss → /atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-cn" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.battcn.com/" title="https://blog.battcn.com/" rel="noopener" target="_blank">唐亚峰 | battcn</a>
        </li>
    </ul>
  </div>
<!-- CloudCalendar -->
<div class="widget-wrap" style="width: 90%;margin-left: auto;margin-right: auto; opacity: 0.97;">
	<div class="widget" id="CloudCalendar"></div>
</div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李文文 | zed</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:28</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  
<!-- calendar widget -->

    <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-calendar/calendar.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-calendar/languages.min.js"></script>
    <script>
    $(function() {
        $('#CloudCalendar').aCalendar('zh-CN',
            $.extend(
                '', {
                    single:true,
                    root:'/calendar/'
                }
            )
        );
    });
    </script>



<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'tPNbcXbsHeBH6mDDuQiRNAIi-gzGzoHsz',
      appKey     : 'DuDTx0gUNp6hJiNaBNXPREQQ',
      placeholder: "欢迎评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
