---
title: 压测性能总结
date: 2019-10-27 23:20:00
updated: 2019-10-27 23:20:00
tags:
  - 性能优化
categories: 
  - 实践
  - 技术小结
comments: true
permalink: tech/11_performance_sum.html    
---

# 0. 背景

临近双11，公司对所有的接口都使用阿里云的全链路压测工具做压测，比如首页的 TPS 是3000，支付的 TPS 是 60，根据不同的接口做不同的策略。其中数值是根据平时的5倍计算得出的。  
这篇博文就是使用阿里云的 arms 监控（APM的一种，类似 skywalking，可以查看请求的每个链路）以及 PTS（做压测的一种工具）对两次压测的优化总结

# 1 MySQL

在支付项目中使用 MySQL 用于存储支付参数、支付结果等信息，主要是短查询和长写入，整个支付下单事务较长，而且由于正在拆解服务，还没有将数据库独立出来，因为数据库性能会收到其它项目的影响从而影响本项目，这是没法避免的

查看最大连接数：
![e82b1e8e6040a09012b5c595ecb0bb20.png](evernotecid://7C43DEBC-F54E-48C8-9331-D22177889D6C/appyinxiangcom/11126461/ENResource/p179)

根据最大连接数，以及多少个集群，来设置项目的连接数，那什么时候才知道是连接数的问题呢？当你在接口的时候，发现某个访问数据库的操作需要5s，但是又发现你查看数据库的语句最慢的才1s，那你就需要怀疑是否是在等待连接而耗费很大量的时间

是否项目上有多余的事务注解，因为我就犯了这个错。原来的某个服务 A 本来是个有更新操作的，但是优化后，将更新操作让 MQ 做，而服务 A 里面只有一个查询和发 MQ，但是我忘记去掉该服务的 Transaction 注解，导致在压测的时候，该服务的响应时间是1分钟，查看链路发现是一个 select 语句就1分钟~当去掉 Transaction 后变成了10ms。

## 2 ONS

ons 是 rocketmq 的商业版，使用基本和 rocketmq 一致。但是没有 rocketmq 好用，我之前公司使用自己搭建的 rocketmq，有问题基本debug，可以能大概定位问题。但是 ons 由于是闭源，只能提工单到他们的工作人员，等待反馈。但是 ons 适合刚初创企业，当业务发展量到了一定程度，使用 rocketmq 是必然的结果！

观察消息的生产消费量，支付相关的消息平时相对来说不是很多，然后再看压测时候的消息大致是多少，当时在压测过程中由于消息使用普通消息，导致没有达到削峰的功能，CPU飙到了 70%，最后在

## 3 Redis

## 4 内部项目接口

## 5 第三方接口

## 6 JVM 优化

nacos

es-project

# 7. mark

常用优化点 jvm

线程执行数

dubbo 配置

数据库连接池

xxl-job 前台应用、执行器分离

健康检查？

消息延迟？

限流保证
